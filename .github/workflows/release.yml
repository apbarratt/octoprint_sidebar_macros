name: Release

on:
  push:
    tags:
      - "*.*.*"
      - "v*.*.*"

permissions:
  contents: write

concurrency:
  group: release-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release:
    name: Build and publish release
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.7"

      - name: Verify tag matches package version
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          python - <<'PY'
          import os
          import pathlib
          import re
          import sys

          tag = os.environ["TAG_NAME"]

          text = pathlib.Path("pyproject.toml").read_text(encoding="utf-8")
          version = None
          in_project = False
          for raw in text.splitlines():
              line = raw.strip()
              if not line or line.startswith("#"):
                  continue
              if line.startswith("["):
                  in_project = (line == "[project]")
                  continue
              if in_project and line.startswith("version"):
                  match = re.match(r'version\\s*=\\s*"([^"]+)"', line)
                  if match:
                      version = match.group(1)
                      break

          if not version:
              print("Could not determine project.version from pyproject.toml")
              sys.exit(1)

          expected = {version, f"v{version}"}
          if tag not in expected:
              print(f"Tag '{tag}' does not match project version '{version}'")
              sys.exit(1)

          print(f"Tag '{tag}' matches project version '{version}'")
          PY

      - name: Build sdist and wheel
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          python -m pip install --upgrade pip
          python -m pip install .
          python -m compileall -q octoprint_sidebar_macros
          python -m pip install "build<1.2"
          python -m build --sdist --wheel
          git archive --format=zip --output dist/Sidebar-Macros.zip "$TAG_NAME"
          sha256sum dist/* > dist/SHA256SUMS.txt

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*
          generate_release_notes: true
